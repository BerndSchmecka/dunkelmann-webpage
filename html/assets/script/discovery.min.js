/*! *****************************************************************************
Copyright (c) Dunkelmann 2021. All rights reserved.

This code is licensed under the BSD License
You should have received a copy of the BSD License
with this code and it is also available through
the world-wide-web at <https://files.dunkelmann.eu/license.txt>.
If you did not receive a copy of the BSD License
and are unable to obtain it through the world-wide-web,
please send a note to <business@dunkelmann.eu> so we can mail you a copy
immediately.
***************************************************************************** */
let DISCOVERY_ENDPOINT="aHR0cHM6Ly9jb3JzLXByb3h5LmR1bmtlbG1hbm4uZXUvNjg3NDc0NzA3MzNhMmYyZjY0Njk3MzYzNmY3NjY1NzI3OTJlNzQ2NTYxNmQ3MzcwNjU2MTZiMmU2MzZmNmQyZjcxNzU2NTcyNzkyZi8=",DEV_DISCOVERY_ENDPOINT="aHR0cHM6Ly9jb3JzLXByb3h5LmR1bmtlbG1hbm4uZXUvNjg3NDc0NzA3MzNhMmYyZjY0NjU3NjJkNjQ2OTczNjM2Zjc2NjU3Mjc5MmU3NDY1NjE2ZDczNzA2NTYxNmIyZTYzNmY2ZDJmNzE3NTY1NzI3OTJmLw==";decodeBase64=function(e){var a,s,r={},n=65,t=0,i=0,o="",c=String.fromCharCode,d=e.length;for(a="";91>n;)a+=c(n++);for(a+=a.toLowerCase()+"0123456789+/",n=0;64>n;n++)r[a.charAt(n)]=n;for(a=0;a<d;a++)for(t=(t<<6)+(n=r[e.charAt(a)]),i+=6;8<=i;)((s=t>>>(i-=8)&255)||a<d-2)&&(o+=c(s));return o},isDevMode=function(){const e=window.location.search,a=new URLSearchParams(e);return!!a.has("mode")&&("dev"===a.get("mode")||(a.get("mode"),!1))},parseUnixTime=function(e){var a=new Date(1e3*e),s="0"+a.getDate(),r="0"+(a.getMonth()+1),n=a.getFullYear(),t="0"+a.getHours(),i="0"+a.getMinutes(),o="0"+a.getSeconds();return s.substr(-2)+"."+r.substr(-2)+"."+n+" - "+t.substr(-2)+":"+i.substr(-2)+":"+o.substr(-2)},randomBanner=function(e){const a=[["rgba(2,25,0,1)","rgba(28,97,20,1)","rgba(16,173,2,1)","rgba(31,255,0,1)"],["rgba(2,0,36,1)","rgba(39,39,200,1)","rgba(2,117,215,1)","rgba(0,212,255,1)"],["rgba(25,0,0,1)","rgba(97,20,20,1)","rgba(173,2,2,1)","rgba(255,0,0,1)"],["rgba(25,25,0,1)","rgba(97,97,20,1)","rgba(169,173,2,1)","rgba(254,255,0,1)"],["rgba(23,0,25,1)","rgba(88,20,97,1)","rgba(157,2,173,1)","rgba(226,0,255,1)"],["rgba(25,14,0,1)","rgba(97,60,20,1)","rgba(173,94,2,1)","rgba(255,128,0,1)"]],s=a[e.charCodeAt(3)%a.length];return`linear-gradient(180deg, ${s[0]} 0%, ${s[1]} 33%, ${s[2]} 63%, ${s[3]} 100%);`},randomIcon=function(e){return`https://www.gravatar.com/avatar/${CryptoJS.MD5(e)}?s=128&d=identicon`},Vue.directive("emoji",{inserted(e){twemoji.parse(e,{size:"svg",ext:".svg"})}}),Vue.component("discovery-card",{props:["card"],template:'\n    <div class="col-md-auto">\n    <div class="discovery-object" v-emoji>\n        <div class="discovery-banner" :style="card.banner"></div>\n        <div class="discovery-icon">\n            <span :style="card.icon"></span>\n        </div>\n        <div class="discovery-name">\n            <div class="discovery-name-text" :title="card.name"> {{ card.name }} </div>\n        </div>\n        <div class="discovery-people">\n            <div class="discovery-people-icon"><i class="fas fa-user fa-discovery-icon"></i></div>\n            <div class="discovery-small-text discovery-people-text"> {{ card.people }} </div>\n        </div>\n        <div class="discovery-desc">\n            <div class="discovery-small-text"> {{ card.topic }} </div>\n        </div>\n        <div class="discovery-created discovery-small-text"> {{ card.created }} </div>\n        <div class="discovery-footer">\n            <div class="discovery-connect">\n                <div class="discovery-small-text discovery-link" :title="card.tooltips.join"> {{ card.join }} </div>\n            </div>\n                <div class="discovery-bookmark" title="Bookmark this server" v-if="card.isServer">\n                    <i class="fas fa-bookmark fa-bookmark-icon"></i>\n                </div>\n                <div class="discovery-channel" :title="card.tooltips.channel" v-if="card.isServer">\n                    <i :class="card.classes.channel"></i>\n                </div>\n                <div class="discovery-homebase" :title="card.tooltips.homebase" v-if="card.isServer">\n                    <i :class="card.classes.homebase"></i>\n                </div>\n        </div>\n    </div>\n</div>\n    '});var app=new Vue({el:"#discoveryApp",data:{cards:[],nodeValue:"",filterValue:""},created:function(){this.doQuery("*%3A*")},methods:{queryWithFilter:function(){app.doQuery((this.nodeValue?`%2B*${encodeURIComponent(this.nodeValue)}*`:"*%3A*")+this.filterValue)},doQuery:function(e){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){var e=JSON.parse(a.responseText);app.cards=[],e.entries.forEach(e=>{app.cards.push({id:e.id,name:e.name,topic:e.topic?e.topic:"No description available",people:(e.members?e.members:0)+("server"===e.type.toLowerCase()?" - "+e.address:""),created:`First seen: ${parseUnixTime(e.created)}`,join:`Join ${e.type.toLowerCase()}`,banner:`background: ${randomBanner(e.id)}`,icon:`background: url('${randomIcon(e.id)}'); background-size: 64px 64px;`,tooltips:{join:"server"===e.type.toLowerCase()?"Open a connection to this server":`Join this ${e.type.toLowerCase()}`,channel:e.canCreateChannel?"Guests can create channels":"Guests can't create channels",homebase:e.canCreateHomebase?"Guests can use this server as homebase":"Guests can't use this server as homebase"},classes:{channel:`fas fa-plus-square ${e.canCreateChannel?"fa-channel-icon text-primary":"fa-channel-icon"}`,homebase:`fas fa-home ${e.canCreateHomebase?"fa-homebase-icon text-primary":"fa-homebase-icon"}`},isServer:"server"===e.type.toLowerCase()})})}},a.open("GET",decodeBase64(isDevMode()?DEV_DISCOVERY_ENDPOINT:DISCOVERY_ENDPOINT)+"?q="+e+"&start=0&rows=30&sort_by=members&sort_order=desc"),a.send()}},watch:{filterValue:function(){this.queryWithFilter()}}});
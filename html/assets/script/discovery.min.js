/*! *****************************************************************************
Copyright (c) Dunkelmann 2021. All rights reserved.

This code is licensed under the BSD License
You should have received a copy of the BSD License
with this code and it is also available through
the world-wide-web at <https://files.dunkelmann.eu/license.txt>.
If you did not receive a copy of the BSD License
and are unable to obtain it through the world-wide-web,
please send a note to <business@dunkelmann.eu> so we can mail you a copy
immediately.
***************************************************************************** */
let DISCOVERY_ENDPOINT="aHR0cHM6Ly9jb3JzLXByb3h5LmR1bmtlbG1hbm4uZXUvNjg3NDc0NzA3MzNhMmYyZjY0Njk3MzYzNmY3NjY1NzI3OTJlNzQ2NTYxNmQ3MzcwNjU2MTZiMmU2MzZmNmQyZjcxNzU2NTcyNzkyZi8=";decodeBase64=function(e){var s,n,a={},t=65,r=0,o=0,i="",c=String.fromCharCode,d=e.length;for(s="";91>t;)s+=c(t++);for(s+=s.toLowerCase()+"0123456789+/",t=0;64>t;t++)a[s.charAt(t)]=t;for(s=0;s<d;s++)for(r=(r<<6)+(t=a[e.charAt(s)]),o+=6;8<=o;)((n=r>>>(o-=8)&255)||s<d-2)&&(i+=c(n));return i},parseUnixTime=function(e){var s=new Date(1e3*e),n="0"+s.getDate(),a="0"+(s.getMonth()+1),t=s.getFullYear(),r="0"+s.getHours(),o="0"+s.getMinutes(),i="0"+s.getSeconds();return n.substr(-2)+"."+a.substr(-2)+"."+t+" - "+r.substr(-2)+":"+o.substr(-2)+":"+i.substr(-2)},discoveryCard=function(e){return`<div class="col-md-auto">\n                <div class="discovery-object">\n                    <div class="discovery-banner" style="background: linear-gradient(180deg, rgba(2,0,36,1) 0%, rgba(39,39,200,1) 33%, rgba(2,117,215,1) 63%, rgba(0,212,255,1) 100%);"></div>\n                    <div class="discovery-icon">\n                        <span style="background: url(assets/discovery/icon_placeholder.png); background-size: 64px 64px;"></span>\n                    </div>\n                    <div class="discovery-name">\n                        <div class="discovery-name-text" title="${e.name}"> ${e.name} </div>\n                    </div>\n                    <div class="discovery-people">\n                        <div class="discovery-people-icon"><i class="fas fa-user fa-discovery-icon"></i></div>\n                        <div class="discovery-small-text discovery-people-text"> ${e.members+("server"===e.type.toLowerCase()?" - "+e.address:"")} </div>\n                    </div>\n                    <div class="discovery-desc">\n                        <div class="discovery-small-text"> ${e.topic?e.topic:"No description available"} </div>\n                    </div>\n                    <div class="discovery-created discovery-small-text"> First seen: ${parseUnixTime(e.created)} </div>\n                    <div class="discovery-footer">\n                        <div class="discovery-connect">\n                            <div class="discovery-small-text discovery-link" title="${"server"===e.type.toLowerCase()?"Open a connection to this server":"Join this "+e.type.toLowerCase()}"> Join ${e.type.toLowerCase()} </div>\n                        </div>\n                        ${"server"===e.type.toLowerCase()?`<div class="discovery-bookmark" title="Bookmark this server">\n                                <i class="fas fa-bookmark fa-bookmark-icon"></i>\n                            </div>\n                            <div class="discovery-channel" title="${e.canCreateChannel?"Guests can create channels":"Guests can't create channels"}">\n                                <i class="fas fa-plus-square ${e.canCreateChannel?"fa-channel-icon text-primary":"fa-channel-icon"}"></i>\n                            </div>\n                            <div class="discovery-homebase" title="${e.canCreateHomebase?"Guests can use this server as homebase":"Guests can't use this server as homebase"}">\n                                <i class="fas fa-home ${e.canCreateHomebase?"fa-homebase-icon text-primary":"fa-homebase-icon"}"></i>\n                            </div>`:""}\n                    </div>\n                </div>\n            </div>`},doQuery=function(e){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var e=JSON.parse(s.responseText);document.getElementById("results").innerHTML="",e.entries.forEach(e=>{document.getElementById("results").innerHTML+=discoveryCard(e)})}},s.open("GET",decodeBase64(DISCOVERY_ENDPOINT)+"?q="+e+"&start=0&rows=30&sort_by=members&sort_order=desc"),s.send()};const node=document.getElementById("searchbox"),filter=document.getElementById("filter");node.addEventListener("keyup",({key:e})=>{"Enter"===e&&doQuery((node.value?`%2B*${encodeURIComponent(node.value)}*`:"*%3A*")+filter.value)}),filter.addEventListener("change",()=>{doQuery((node.value?`%2B*${encodeURIComponent(node.value)}*`:"*%3A*")+filter.value)}),doQuery("*%3A*");